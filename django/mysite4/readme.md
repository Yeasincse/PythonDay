##Get Google OauthID


+ In https://console.developers.google.com/apis/credentials/oauthclient in section restriction
+ we must enable Google+ API
+ Authorized JavaScript origins: http://localhost:8080
+ Authorized redirect URIs: http://localhost:8000/complete/google-oauth2/
+ create a json file "/mysite3/google_oauth.key"
```json
        {
          "key":"xxx.apps.googleusercontent.com",
          "secret":"yyy"
        }
```

##Prepare an App

+ create project and database
```shell
        django-admin startproject mysite3
        python manage.py migrate
        python manage.py createsuperuser --username=admin
```

+ create app by using "python manage.py startapp myapp" or copy the previous app

+ Add the app's name in "mysite3/sitting.py"
+ Add the url of the app in "mysite3/urls.py"
```python
        from django.conf.urls import url, include
        from django.contrib import admin
        urlpatterns = [ 
            url(r'^admin/', admin.site.urls),
            url(r'^myapp/', include('myapp.urls')),
        ]
```

+ create /mysite3/myapp/urls.py

```python
        from django.conf.urls import url
        from . import views
        urlpatterns = [
            url(r'^home/', views.home, name='home'),
        ]

```

+ create /mysite3/myapp/templates/home.html

```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8"/>
            <title>Home</title>
        </head>
        <body>
            <form method="post" action="{% url 'home' %}">{% csrf_token %}
                {% if uname %}
                    Helo, {{uname}}<br>
                    The user already signed in. He may need to sign out<br>
                    <input type="submit" name="submit" value="sign-out">            
                {% else %}
                    Please sign-in<br>
                    <input type="submit" name="submit" value="sign-in">
                {% endif %}  
            </form> 
        </body>
        </html>
```

+ create /mysite3/myapp/view.py

```python
        from django.shortcuts import render
        def home(request):
            uname=""
            if request.method == 'POST' and 'submit' in request.POST:
                submit = request.POST['submit']
                if submit=="sign-out":
                    uname=""
                if submit=="sign-in":
                    uname="Wasit"
            return render(request,'home.html',{'uname': uname})
```

##Setup Python-social-auth

Please check master reposiory https://github.com/omab/python-social-auth

+ you may use pip to install.

```shell
        pip install python-social-auth
```

+ config "\mysite3h\setting.py"

```python
        INSTALLED_APPS = [
            'django.contrib.admin',
            'django.contrib.auth',
            'django.contrib.contenttypes',
            'django.contrib.sessions',
            'django.contrib.messages',
            'django.contrib.staticfiles',
            'myapp',
            'social.apps.django_app.default',
        ]
        
        import json
        with open('google_oauth.key') as keyfile: oauthkey = json.load(keyfile)
        SOCIAL_AUTH_GOOGLE_OAUTH2_KEY = oauthkey['key']
        SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET = oauthkey['secret']
        AUTHENTICATION_BACKENDS = (
            'social.backends.google.GoogleOAuth2',
            'django.contrib.auth.backends.ModelBackend',
        )
        SOCIAL_AUTH_USERNAME_IS_FULL_EMAIL = True
        SOCIAL_AUTH_LOGIN_REDIRECT_URL = '/myapp/home/'
```

+ dont forget to add /mysite3/google_oauth.key to get your key, pelase visit https://console.developers.google.com/apis/credentials

+ in /mysite3/urls.py, add social-auth to urlpatterns

``` python
        url('', include('social.apps.django_app.urls', namespace='social')),
```

+ create table in database for social-auth by **python manage.py migrate**

##Edit View

In mysite3/myauthen/view.py, we can get user detail from seesion. However, I couldn't find user in seesion dictionary. Therefore we can get user name or email by query from database, table "social_auth_usersocialauth". In Django, the database query is manipulated by Python classes called "model". In order to get detail from the table we have to import the social app model.

```python
        import social.apps.django_app.default.models as sm
```
My method to get the user name or email is by looking up for a user ID that comes from session.

```python
        uname=sm.UserSocialAuth.objects.get(user_id=int(request.session['_auth_user_id'])).user
```

**sm.UserSocialAuth** to get the table

**.objects** to convert to object

**get([field]=[target])** we can get a record that has value in the field match the target

**int(request.session['_auth_user_id'])** to get user ID that generated by social oauth 

**.user** to get the user name or email

```python
        from django.shortcuts import render
        import social.apps.django_app.default.models as sm
        from django.contrib.auth import authenticate, login, logout
        def home(request):
            uname=""
            if request.method == 'POST' and 'submit' in request.POST:
                submit = request.POST['submit']
                if submit=="sign-out":
                    logout(request)
            if '_auth_user_id' in request.session:
                uname=sm.UserSocialAuth.objects.get(
                    user_id=int(request.session['_auth_user_id'])
                    ).user
            return render(request,'home.html',{'uname': uname})
```

##Edit Template

we can let user login via Google Oauth2 by using view.py to render the simple template

```html
        <a href="{% url 'social:begin' 'google-oauth2' %}">Google login</a>
```

or using more interesting botton from Font Awesome

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

+ render with Jinja template

```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8"/>
            <title>Home</title>
        </head>
        <body>
            <form method="post" action="{% url 'home' %}">{% csrf_token %}
                {% if uname %}
                    Helo, {{uname}}<br>
                    The user already signed in. He may need to sign out<br>
                    <input type="submit" name="submit" value="sign-out">            
                {% else %}
                    Please sign-in<br>
                    <a href="{% url 'social:begin' 'google-oauth2' %}">Google login</a>
                {% endif %}  
            </form> 
        </body>
        </html>
```
